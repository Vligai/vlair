#!/usr/bin/env python3
"""
Malware Triage Workflow
Quick analysis of suspicious files
"""

import sys
import hashlib
from pathlib import Path
from typing import Dict, Any

sys.path.insert(0, str(Path(__file__).parent.parent))

from core.workflow import Workflow, WorkflowStep, StepResult, WorkflowContext, workflow
from core.scorer import Severity


@workflow
class MalwareTriageWorkflow(Workflow):
    """
    Malware Triage Workflow

    Steps:
    1. Calculate file hashes (MD5, SHA256)
    2. Check hashes against threat intelligence
    3. Scan with YARA rules
    4. If script: attempt deobfuscation
    5. Extract IOCs from file content
    6. Check extracted IOCs
    7. Generate malware risk score
    """

    @property
    def name(self) -> str:
        return "malware-triage"

    @property
    def description(self) -> str:
        return "Quick malware analysis and triage"

    def _define_steps(self):
        self.steps = [
            WorkflowStep(name="calculate_hashes", description="Calculate file hashes", tool="internal", required=True),
            WorkflowStep(
                name="check_hashes",
                description="Check hashes against threat intel",
                tool="hash_lookup",
                required=True,
                depends_on=["calculate_hashes"],
            ),
            WorkflowStep(
                name="yara_scan",
                description="Scan with YARA rules",
                tool="yara_scanner",
                required=False,
                depends_on=["calculate_hashes"],
            ),
            WorkflowStep(
                name="deobfuscate",
                description="Deobfuscate script (if applicable)",
                tool="deobfuscator",
                required=False,
                depends_on=["calculate_hashes"],
            ),
            WorkflowStep(
                name="extract_iocs",
                description="Extract IOCs from file",
                tool="ioc_extractor",
                required=False,
                depends_on=["calculate_hashes"],
            ),
            WorkflowStep(
                name="check_iocs",
                description="Check extracted IOCs",
                tool="multi",
                required=False,
                depends_on=["extract_iocs"],
            ),
            WorkflowStep(name="calculate_score", description="Generate malware risk score", tool="scorer", required=True),
        ]

    def _execute_step(self, step: WorkflowStep, context: WorkflowContext) -> StepResult:
        """Execute a single workflow step"""

        if step.name == "calculate_hashes":
            return self._calculate_hashes(context)
        elif step.name == "check_hashes":
            return self._check_hashes(context)
        elif step.name == "yara_scan":
            return self._yara_scan(context)
        elif step.name == "deobfuscate":
            return self._deobfuscate(context)
        elif step.name == "extract_iocs":
            return self._extract_iocs(context)
        elif step.name == "check_iocs":
            return self._check_iocs(context)
        elif step.name == "calculate_score":
            return self._calculate_score(context)
        else:
            return StepResult(step_name=step.name, success=False, error="Unknown step")

    def _calculate_hashes(self, context: WorkflowContext) -> StepResult:
        """Calculate file hashes"""
        try:
            file_path = Path(context.input_value)

            if not file_path.exists():
                return StepResult(step_name="calculate_hashes", success=False, error=f"File not found: {context.input_value}")

            with open(file_path, "rb") as f:
                content = f.read()

            md5 = hashlib.md5(content).hexdigest()
            sha1 = hashlib.sha1(content).hexdigest()
            sha256 = hashlib.sha256(content).hexdigest()

            hashes = {"md5": md5, "sha1": sha1, "sha256": sha256, "file_size": len(content)}

            context.data["hashes"] = hashes
            context.data["file_content"] = content
            context.data["file_extension"] = file_path.suffix.lower()
            context.add_iocs("hashes", [md5, sha256])

            return StepResult(step_name="calculate_hashes", success=True, data=hashes)

        except Exception as e:
            return StepResult(step_name="calculate_hashes", success=False, error=str(e))

    def _check_hashes(self, context: WorkflowContext) -> StepResult:
        """Check hashes against threat intelligence"""
        hashes = context.data.get("hashes", {})
        sha256 = hashes.get("sha256")

        if not sha256:
            return StepResult(step_name="check_hashes", success=False, error="No hash available")

        try:
            from hashLookup.lookup import HashLookup

            lookup = HashLookup(verbose=self.verbose)
            result = lookup.lookup(sha256)

            context.add_tool_result("hash_lookup", result)

            # Add findings
            if result.get("verdict") == "malicious":
                context.scorer.add_finding(Severity.CRITICAL, f"File hash is KNOWN MALWARE", "hash_lookup", result)

                # Check for malware family
                mb = result.get("sources", {}).get("malwarebazaar", {})
                if mb.get("malware_family"):
                    context.scorer.add_finding(
                        Severity.CRITICAL,
                        f"Identified malware family: {mb['malware_family']}",
                        "hash_lookup",
                        {"family": mb["malware_family"]},
                    )

            elif result.get("verdict") == "suspicious":
                context.scorer.add_finding(Severity.HIGH, "File hash flagged by some security vendors", "hash_lookup", result)

            return StepResult(step_name="check_hashes", success=True, data=result)

        except ImportError:
            return StepResult(step_name="check_hashes", success=False, error="Hash lookup not available")
        except Exception as e:
            return StepResult(step_name="check_hashes", success=False, error=str(e))

    def _yara_scan(self, context: WorkflowContext) -> StepResult:
        """Scan file with YARA rules"""
        try:
            from yaraScanner.scanner import YaraScanner

            scanner = YaraScanner(verbose=self.verbose)
            result = scanner.scan_file(context.input_value)

            context.add_tool_result("yara_scanner", result)

            # Add findings for matches
            matches = result.get("matches", [])
            for match in matches:
                rule = match.get("rule", "Unknown")
                severity_str = match.get("severity", "medium").lower()

                if severity_str == "critical":
                    sev = Severity.CRITICAL
                elif severity_str == "high":
                    sev = Severity.HIGH
                elif severity_str == "medium":
                    sev = Severity.MEDIUM
                else:
                    sev = Severity.LOW

                context.scorer.add_finding(sev, f"YARA rule matched: {rule}", "yara_scanner", match)

            if matches:
                self._log(f"  {len(matches)} YARA rules matched")

            return StepResult(step_name="yara_scan", success=True, data=result)

        except ImportError:
            return StepResult(step_name="yara_scan", success=False, error="YARA scanner not available")
        except Exception as e:
            return StepResult(step_name="yara_scan", success=False, error=str(e))

    def _deobfuscate(self, context: WorkflowContext) -> StepResult:
        """Deobfuscate script files"""
        ext = context.data.get("file_extension", "")
        script_extensions = {".js", ".ps1", ".vbs", ".bat", ".cmd", ".py", ".sh"}

        if ext not in script_extensions:
            return StepResult(
                step_name="deobfuscate", success=True, data={"message": "Not a script file, skipping deobfuscation"}
            )

        try:
            from deobfuscator.deobfuscator import Deobfuscator

            deob = Deobfuscator(verbose=self.verbose)
            result = deob.deobfuscate_file(context.input_value)

            context.add_tool_result("deobfuscator", result)

            # Add findings
            layers = result.get("layers_decoded", 0)
            if layers > 0:
                if layers >= 3:
                    context.scorer.add_finding(
                        Severity.HIGH, f"Script was heavily obfuscated ({layers} layers)", "deobfuscator", {"layers": layers}
                    )
                else:
                    context.scorer.add_finding(
                        Severity.MEDIUM, f"Script was obfuscated ({layers} layers)", "deobfuscator", {"layers": layers}
                    )

            # Add extracted IOCs
            extracted_iocs = result.get("extracted_iocs", {})
            context.add_iocs("urls", extracted_iocs.get("urls", []))
            context.add_iocs("domains", extracted_iocs.get("domains", []))
            context.add_iocs("ips", extracted_iocs.get("ips", []))

            return StepResult(step_name="deobfuscate", success=True, data=result)

        except ImportError:
            return StepResult(step_name="deobfuscate", success=False, error="Deobfuscator not available")
        except Exception as e:
            return StepResult(step_name="deobfuscate", success=False, error=str(e))

    def _extract_iocs(self, context: WorkflowContext) -> StepResult:
        """Extract IOCs from file content"""
        try:
            from iocExtractor.extractor import IOCExtractor

            extractor = IOCExtractor(exclude_private_ips=True)
            result = extractor.extract_from_file(context.input_value)

            context.add_tool_result("ioc_extractor", result)

            # Add IOCs to context
            context.add_iocs("domains", result.get("domains", []))
            context.add_iocs("ips", result.get("ips", []))
            context.add_iocs("urls", result.get("urls", []))
            context.add_iocs("emails", result.get("emails", []))

            total_iocs = len(result.get("domains", [])) + len(result.get("ips", [])) + len(result.get("urls", []))
            if total_iocs > 5:
                context.scorer.add_finding(
                    Severity.MEDIUM,
                    f"File contains {total_iocs} network indicators",
                    "ioc_extractor",
                    {"total_iocs": total_iocs},
                )

            return StepResult(step_name="extract_iocs", success=True, data=result)

        except ImportError:
            return StepResult(step_name="extract_iocs", success=False, error="IOC extractor not available")
        except Exception as e:
            return StepResult(step_name="extract_iocs", success=False, error=str(e))

    def _check_iocs(self, context: WorkflowContext) -> StepResult:
        """Check extracted IOCs against threat intelligence"""
        results = {}

        # Check domains
        domains = context.iocs.get("domains", [])[:3]
        if domains:
            try:
                from domainIpIntel.intel import DomainIPIntelligence as DomainIPIntel

                intel = DomainIPIntel(verbose=self.verbose)

                for domain in domains:
                    result = intel.lookup(domain)
                    if result.get("verdict") == "malicious":
                        context.scorer.add_finding(
                            Severity.HIGH, f"File contacts malicious domain: {domain}", "domain_intel", result
                        )
                results["domains"] = True
            except Exception:
                pass

        # Check URLs
        urls = context.iocs.get("urls", [])[:3]
        if urls:
            try:
                from urlAnalyzer.analyzer import URLAnalyzer

                analyzer = URLAnalyzer(verbose=self.verbose)

                for url in urls:
                    result = analyzer.analyze(url)
                    if result.get("verdict") == "malicious":
                        context.scorer.add_finding(
                            Severity.HIGH, f"File contacts malicious URL: {url[:50]}...", "url_analyzer", result
                        )
                results["urls"] = True
            except Exception:
                pass

        return StepResult(step_name="check_iocs", success=True, data=results)

    def _calculate_score(self, context: WorkflowContext) -> StepResult:
        """Calculate final malware risk score"""
        summary = context.scorer.get_summary()

        recommendations = []

        if summary["risk_score"] >= 70:
            recommendations.extend(
                [
                    "QUARANTINE file immediately",
                    "Do NOT execute or open the file",
                    "Submit to malware sandbox for detailed analysis",
                    "Check for other instances of this file in the network",
                    "Review how this file entered the environment",
                ]
            )
        elif summary["risk_score"] >= 40:
            recommendations.extend(
                ["Treat file as suspicious", "Submit to sandbox for analysis before opening", "Monitor for related activity"]
            )
        else:
            recommendations.append("File appears low risk, but verify source before opening")

        return StepResult(
            step_name="calculate_score",
            success=True,
            data={"risk_score": summary["risk_score"], "verdict": summary["verdict"], "recommendations": recommendations},
        )
